name: Deploy Documentation to Vercel

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'user-docs/**'
      - 'frontend/src/**/*.stories.tsx'
      - 'frontend/src/**/*.stories.ts'
      - 'frontend/src/**/*.mdx'
      - 'frontend/.storybook/**'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Which documentation to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mkdocs
          - docusaurus
          - storybook

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

jobs:
  # ============================================
  # MkDocs - Documentation Technique
  # ============================================
  deploy-mkdocs:
    name: ðŸ“š Deploy MkDocs
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'mkdocs'))
      || (github.event_name == 'push' && contains(toJson(github.event.commits.*.modified), 'docs/'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: docs/requirements.txt

      - name: Install dependencies
        run: pip install -r docs/requirements.txt

      - name: Build MkDocs
        run: cd docs && mkdocs build

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        run: |
          cd docs/site
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            --yes
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_MKDOCS_PROJECT_ID }}

  # ============================================
  # Docusaurus - Guide Utilisateur
  # ============================================
  deploy-docusaurus:
    name: ðŸ“– Deploy Docusaurus
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'docusaurus'))
      || (github.event_name == 'push' && contains(toJson(github.event.commits.*.modified), 'user-docs/'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: user-docs/package-lock.json

      - name: Install dependencies
        run: cd user-docs && npm ci

      - name: Build Docusaurus
        run: cd user-docs && npm run build

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        run: |
          cd user-docs/build
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            --yes
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_DOCUSAURUS_PROJECT_ID }}

  # ============================================
  # Storybook - Composants UI
  # ============================================
  deploy-storybook:
    name: ðŸŽ¨ Deploy Storybook
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'storybook'))
      || (github.event_name == 'push' && (contains(toJson(github.event.commits.*.modified), '.stories.') || contains(toJson(github.event.commits.*.modified), '.storybook/')))

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: cd frontend && npm ci

      - name: Build Storybook
        run: cd frontend && npm run build-storybook

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        run: |
          cd frontend/storybook-static
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            --yes
        env:
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_STORYBOOK_PROJECT_ID }}
