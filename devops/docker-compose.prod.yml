name: skillswap-prod

services:
  backend:
    build:
      context: ..
      dockerfile: ./devops/backend/Dockerfile.prod
    restart: always
    expose:
      - '3000'
    env_file:
      - .env.docker
    environment:
      - NODE_ENV=production
    volumes:
      - avatars_data:/app/public/avatars
    command:
      ['wait-for-postgres.sh', 'postgres', '5432', 'node', 'dist/index.js']
    depends_on:
      postgres:
        condition: service_healthy
      meilisearch:
        condition: service_started
    healthcheck:
      test: ['CMD', 'nc', '-z', 'localhost', '3000']
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ../frontend
      dockerfile: ../devops/frontend/Dockerfile.prod
    restart: always
    expose:
      - '3000'
    env_file:
      - .env.docker
    environment:
      - NODE_ENV=production
    depends_on:
      - backend
    healthcheck:
      test: ['CMD', 'nc', '-z', 'localhost', '3000']
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:16-alpine
    container_name: skillswap-postgres-prod
    restart: always
    env_file:
      - .env.docker
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${POSTGRES_USER:-skillswap} -d ${POSTGRES_DB:-skillswap}',
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  meilisearch:
    image: getmeili/meilisearch:v1.6
    container_name: skillswap-meilisearch-prod
    restart: always
    expose:
      - '7700'
    env_file:
      - .env.docker
    environment:
      - MEILI_ENV=production
      - MEILI_NO_ANALYTICS=true
    volumes:
      - meilisearch_data:/meili_data

  nginx:
    image: nginx:alpine
    container_name: skillswap-nginx-prod
    restart: always
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/prod.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot_www:/var/www/certbot:ro
      - certbot_conf:/etc/letsencrypt:ro
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'nc', '-z', 'localhost', '80']
      interval: 30s
      timeout: 10s
      retries: 3

  # Certbot pour SSL (Let's Encrypt)
  certbot:
    image: certbot/certbot
    container_name: skillswap-certbot
    volumes:
      - certbot_www:/var/www/certbot
      - certbot_conf:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  postgres_data:
  meilisearch_data:
  certbot_www:
  certbot_conf:
  avatars_data:
